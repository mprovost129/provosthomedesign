{% extends 'billing/base_authenticated.html' %}
{% load humanize %}

{% block title %}Add Time to Invoice{% endblock %}

{% block authenticated_content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>Add Time to Invoice</h2>
    <a href="{% url 'timetracking:entries_list' %}" class="btn btn-outline-secondary">
        <i class="fas fa-arrow-left"></i> Back
    </a>
</div>

<form method="post">
    {% csrf_token %}
    
    <div class="row mb-4">
        <!-- Invoice Selection -->
        <div class="col-md-6">
            <div class="card shadow-sm">
                <div class="card-header bg-white">
                    <h5 class="mb-0">Invoice Selection</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="invoice_id" class="form-label">Add to Invoice</label>
                        <select name="invoice_id" id="invoice_id" class="form-select" required>
                            <option value="new">Create New Invoice</option>
                            {% for invoice in invoices %}
                            <option value="{{ invoice.id }}">
                                #{{ invoice.invoice_number }} - {{ invoice.client.first_name }} {{ invoice.client.last_name }} - ${{ invoice.total|floatformat:2 }}
                            </option>
                            {% endfor %}
                        </select>
                        <small class="form-text text-muted">
                            Select an existing invoice or create a new one
                        </small>
                    </div>
                    
                    <div class="mb-3">
                        <label for="hourly_rate" class="form-label">Hourly Rate *</label>
                        <div class="input-group">
                            <span class="input-group-text">$</span>
                            <input type="number" name="hourly_rate" id="hourly_rate" 
                                   class="form-control" step="0.01" min="0" required 
                                   placeholder="150.00">
                        </div>
                        <small class="form-text text-muted">
                            Rate to apply to all selected entries
                        </small>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Summary -->
        <div class="col-md-6">
            <div class="card shadow-sm">
                <div class="card-header bg-white">
                    <h5 class="mb-0">Summary</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <div class="d-flex justify-content-between">
                            <span class="text-muted">Selected Entries:</span>
                            <strong id="selected-count">0</strong>
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="d-flex justify-content-between">
                            <span class="text-muted">Total Hours:</span>
                            <strong id="total-hours">0.00</strong>
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="d-flex justify-content-between">
                            <span class="text-muted">Estimated Total:</span>
                            <strong id="estimated-total">$0.00</strong>
                        </div>
                    </div>
                    <hr>
                    <div class="alert alert-info mb-0">
                        <small>
                            <i class="fas fa-info-circle"></i>
                            Select time entries below and set your hourly rate to see the estimated invoice total.
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Filter by Project -->
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Unbilled Time Entries</h5>
            <div>
                <label for="filter-project" class="me-2">Filter:</label>
                <select id="filter-project" class="form-select form-select-sm d-inline-block" style="width: auto;">
                    <option value="">All Projects</option>
                    {% for project in projects %}
                    <option value="{{ project.id }}">{{ project.job_name }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
        <div class="card-body p-0">
            {% if entries %}
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th style="width: 40px;">
                                <input type="checkbox" id="select-all" class="form-check-input">
                            </th>
                            <th>Date</th>
                            <th>Project</th>
                            <th>Start</th>
                            <th>End</th>
                            <th>Duration</th>
                            <th>Hours</th>
                            <th>Description</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for entry in entries %}
                        <tr class="time-entry-row" data-project-id="{{ entry.project.id }}" data-hours="{{ entry.get_duration_decimal }}">
                            <td>
                                <input type="checkbox" name="time_entries" value="{{ entry.id }}" 
                                       class="form-check-input entry-checkbox" data-hours="{{ entry.get_duration_decimal }}">
                            </td>
                            <td>{{ entry.start_time|date:"M d, Y" }}</td>
                            <td>{{ entry.project.job_name }}</td>
                            <td>{{ entry.start_time|time:"g:i A" }}</td>
                            <td>{{ entry.end_time|time:"g:i A" }}</td>
                            <td><strong>{{ entry.get_duration_display }}</strong></td>
                            <td>{{ entry.get_duration_decimal }}</td>
                            <td>
                                {% if entry.description %}
                                {{ entry.description|truncatewords:20 }}
                                {% else %}
                                <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="p-5 text-center text-muted">
                <i class="fas fa-check-circle fa-3x mb-3"></i>
                <p>All billable time entries have been invoiced!</p>
                <p><a href="{% url 'timetracking:time_dashboard' %}">Back to Time Tracking</a></p>
            </div>
            {% endif %}
        </div>
    </div>
    
    {% if entries %}
    <div class="d-flex gap-2">
        <button type="submit" class="btn btn-primary btn-lg" id="submit-btn" disabled>
            <i class="fas fa-file-invoice-dollar"></i> Add to Invoice
        </button>
        <a href="{% url 'timetracking:entries_list' %}" class="btn btn-outline-secondary btn-lg">Cancel</a>
    </div>
    {% endif %}
</form>

<script>
// Track selected entries and calculate totals
function updateSummary() {
    const checkboxes = document.querySelectorAll('.entry-checkbox:checked');
    const hourlyRate = parseFloat(document.getElementById('hourly_rate').value) || 0;
    
    let totalHours = 0;
    checkboxes.forEach(cb => {
        totalHours += parseFloat(cb.dataset.hours);
    });
    
    const estimatedTotal = totalHours * hourlyRate;
    
    document.getElementById('selected-count').textContent = checkboxes.length;
    document.getElementById('total-hours').textContent = totalHours.toFixed(2);
    document.getElementById('estimated-total').textContent = '$' + estimatedTotal.toFixed(2);
    
    // Enable/disable submit button
    document.getElementById('submit-btn').disabled = checkboxes.length === 0;
}

// Select all checkbox
document.getElementById('select-all')?.addEventListener('change', function() {
    const filterProject = document.getElementById('filter-project').value;
    const checkboxes = document.querySelectorAll('.entry-checkbox');
    
    checkboxes.forEach(cb => {
        const row = cb.closest('.time-entry-row');
        if (!filterProject || row.dataset.projectId === filterProject) {
            if (row.style.display !== 'none') {
                cb.checked = this.checked;
            }
        }
    });
    
    updateSummary();
});

// Individual checkbox change
document.querySelectorAll('.entry-checkbox').forEach(cb => {
    cb.addEventListener('change', updateSummary);
});

// Hourly rate change
document.getElementById('hourly_rate')?.addEventListener('input', updateSummary);

// Project filter
document.getElementById('filter-project')?.addEventListener('change', function() {
    const selectedProject = this.value;
    const rows = document.querySelectorAll('.time-entry-row');
    
    rows.forEach(row => {
        if (!selectedProject || row.dataset.projectId === selectedProject) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
            // Uncheck hidden entries
            const checkbox = row.querySelector('.entry-checkbox');
            if (checkbox) checkbox.checked = false;
        }
    });
    
    // Update select all checkbox
    document.getElementById('select-all').checked = false;
    updateSummary();
});

// Initialize summary
updateSummary();
</script>
{% endblock %}
