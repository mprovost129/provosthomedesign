{% extends 'billing/base_authenticated.html' %}
{% load humanize %}

{% block title %}Time Tracking{% endblock %}

{% block authenticated_content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>Time Tracking</h2>
    <div class="d-flex gap-2">
        <a href="{% url 'timetracking:entries_list' %}" class="btn btn-outline-primary">
            <i class="fas fa-list"></i> All Entries
        </a>
        <a href="{% url 'timetracking:create_entry' %}" class="btn btn-primary">
            <i class="fas fa-plus"></i> Add Manual Entry
        </a>
    </div>
</div>

<!-- Timer Widget -->
<div class="card shadow-sm mb-4" id="timer-widget">
    <div class="card-body">
        <div class="row align-items-center">
            <div class="col-md-4">
                <h5 class="mb-2">Quick Timer</h5>
                {% if active_timer %}
                <div class="text-muted small">
                    <i class="fas fa-play-circle text-success"></i> 
                    Currently tracking: <strong>{{ active_timer.time_entry.project.job_name }}</strong>
                </div>
                {% else %}
                <div class="text-muted small">
                    <i class="fas fa-stop-circle text-secondary"></i> 
                    No active timer
                </div>
                {% endif %}
            </div>
            
            <div class="col-md-4 text-center">
                <div id="timer-display" class="display-4 fw-bold text-primary" style="font-family: 'Courier New', monospace;">
                    {% if active_timer %}
                    <span id="timer-hours">00</span>:<span id="timer-minutes">00</span>:<span id="timer-seconds">00</span>
                    {% else %}
                    00:00:00
                    {% endif %}
                </div>
            </div>
            
            <div class="col-md-4">
                {% if active_timer %}
                <button id="stop-timer-btn" class="btn btn-danger btn-lg w-100">
                    <i class="fas fa-stop"></i> Stop Timer
                </button>
                {% else %}
                <form id="start-timer-form" class="d-flex gap-2">
                    {% csrf_token %}
                    {{ timer_form.project }}
                    <button type="submit" id="start-timer-btn" class="btn btn-success">
                        <i class="fas fa-play"></i> Start
                    </button>
                </form>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Today's Summary -->
<div class="row mb-4">
    <div class="col-md-4">
        <div class="card shadow-sm">
            <div class="card-body">
                <h6 class="text-muted mb-2">Today's Total Time</h6>
                <h3 class="mb-0" id="today-total">{{ today_total|default:"0:00" }}</h3>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card shadow-sm">
            <div class="card-body">
                <h6 class="text-muted mb-2">Entries Today</h6>
                <h3 class="mb-0">{{ today_entries.count }}</h3>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card shadow-sm">
            <div class="card-body">
                <h6 class="text-muted mb-2">Projects Worked On</h6>
                <h3 class="mb-0">{{ projects_today|length }}</h3>
            </div>
        </div>
    </div>
</div>

<!-- Today's Entries by Project -->
<div class="card shadow-sm mb-4">
    <div class="card-header bg-white">
        <h5 class="mb-0">Today's Time Entries</h5>
    </div>
    <div class="card-body p-0">
        {% if projects_today %}
        {% for project_name, data in projects_today.items %}
        <div class="p-3 border-bottom">
            <div class="d-flex justify-content-between align-items-start mb-2">
                <div>
                    <h6 class="mb-1">
                        <a href="{% url 'timetracking:project_entries' data.project.id %}">
                            {{ project_name }}
                        </a>
                    </h6>
                    <span class="badge bg-primary">{{ data.total }}</span>
                </div>
            </div>
            
            <div class="table-responsive">
                <table class="table table-sm table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>Start</th>
                            <th>End</th>
                            <th>Duration</th>
                            <th>Description</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for entry in data.entries %}
                        <tr>
                            <td>{{ entry.start_time|time:"g:i A" }}</td>
                            <td>
                                {% if entry.end_time %}
                                {{ entry.end_time|time:"g:i A" }}
                                {% else %}
                                <span class="badge bg-success">Running</span>
                                {% endif %}
                            </td>
                            <td><strong>{{ entry.get_duration_display }}</strong></td>
                            <td>
                                {% if entry.description %}
                                {{ entry.description|truncatewords:10 }}
                                {% else %}
                                <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                            <td>
                                <div class="btn-group btn-group-sm">
                                    <a href="{% url 'timetracking:edit_entry' entry.pk %}" class="btn btn-outline-primary btn-sm">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                    <form method="post" action="{% url 'timetracking:delete_entry' entry.pk %}" style="display: inline;" 
                                          onsubmit="return confirm('Delete this time entry?');">
                                        {% csrf_token %}
                                        <button type="submit" class="btn btn-outline-danger btn-sm">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </form>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% endfor %}
        {% else %}
        <div class="p-5 text-center text-muted">
            <i class="fas fa-clock fa-3x mb-3"></i>
            <p>No time entries for today yet.</p>
            <p>Start the timer above or <a href="{% url 'timetracking:create_entry' %}">add a manual entry</a>.</p>
        </div>
        {% endif %}
    </div>
</div>

<script>
let timerInterval = null;
let startTime = null;

{% if active_timer %}
// Initialize timer with current values
startTime = new Date("{{ active_timer.time_entry.start_time|date:'c' }}");
updateTimerDisplay();
timerInterval = setInterval(updateTimerDisplay, 1000);
{% endif %}

function updateTimerDisplay() {
    if (!startTime) return;
    
    const now = new Date();
    const elapsed = Math.floor((now - startTime) / 1000); // seconds
    
    const hours = Math.floor(elapsed / 3600);
    const minutes = Math.floor((elapsed % 3600) / 60);
    const seconds = elapsed % 60;
    
    document.getElementById('timer-hours').textContent = String(hours).padStart(2, '0');
    document.getElementById('timer-minutes').textContent = String(minutes).padStart(2, '0');
    document.getElementById('timer-seconds').textContent = String(seconds).padStart(2, '0');
}

// Start timer
document.getElementById('start-timer-form')?.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const projectId = document.getElementById('quick-timer-project').value;
    if (!projectId) {
        alert('Please select a project');
        return;
    }
    
    try {
        const response = await fetch('{% url "timetracking:start_timer" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({ project_id: projectId })
        });
        
        const data = await response.json();
        
        if (data.success) {
            location.reload();
        } else {
            alert(data.error || 'Failed to start timer');
        }
    } catch (error) {
        console.error('Error starting timer:', error);
        alert('Failed to start timer');
    }
});

// Stop timer
document.getElementById('stop-timer-btn')?.addEventListener('click', async () => {
    if (!confirm('Stop the timer?')) return;
    
    try {
        const response = await fetch('{% url "timetracking:stop_timer" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            location.reload();
        } else {
            alert(data.error || 'Failed to stop timer');
        }
    } catch (error) {
        console.error('Error stopping timer:', error);
        alert('Failed to stop timer');
    }
});
</script>
{% endblock %}
