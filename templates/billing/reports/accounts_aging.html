{% extends 'billing/base_authenticated.html' %}
{% load humanize %}

{% block title %}Accounts Aging{% endblock %}

{% block authenticated_content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h2 class="mb-0">Accounts Aging</h2>
  <div>
    <a href="{% url 'billing:accounts_aging_csv' %}" class="btn btn-outline-primary">Export CSV</a>
  </div>
  </div>
<p class="text-muted">As of {{ today|date:'M d, Y' }}.</p>

<div class="d-flex justify-content-between align-items-center mb-3">
  <div></div>
  <form method="get" class="d-flex gap-2">
    <input type="date" name="asof" value="{{ today|date:'Y-m-d' }}" class="form-control"/>
    <button class="btn btn-secondary">Apply</button>
    <a href="{% url 'billing:accounts_aging_report' %}" class="btn btn-outline-secondary">Reset</a>
    <a href="{% url 'billing:accounts_aging_csv' %}?asof={{ today|date:'Y-m-d' }}" class="btn btn-outline-primary">Export CSV</a>
    <a href="{% url 'billing:accounts_aging_pdf' %}?asof={{ today|date:'Y-m-d' }}" class="btn btn-outline-primary">Export PDF</a>
    <a href="{% url 'billing:export_reports_bundle' %}?asof={{ today|date:'Y-m-d' }}" class="btn btn-outline-primary">Export All (ZIP)</a>
  </form>
</div>

<div class="row g-3 mb-4">
  <div class="col-lg-6">
    <div class="card h-100">
      <div class="card-header bg-white"><strong>Totals</strong></div>
      <div class="card-body">
        <div class="d-flex justify-content-between mb-2">
          <span>Total Outstanding</span>
          <strong>${{ totals.outstanding_total|floatformat:2|intcomma }}</strong>
        </div>
        <div class="d-flex justify-content-between mb-2">
          <span>Current</span>
          <strong>${{ totals.current_total|floatformat:2|intcomma }}</strong>
        </div>
        <div class="d-flex justify-content-between">
          <span>Overdue</span>
          <strong class="text-danger">${{ totals.overdue_total|floatformat:2|intcomma }}</strong>
        </div>
      </div>
    </div>
  </div>
  <div class="col-lg-6">
    <div class="card h-100">
      <div class="card-header bg-white"><strong>Aging Buckets</strong></div>
      <div class="card-body">
        <ul class="list-group list-group-flush">
          {% for key,b in buckets.items %}
          <li class="list-group-item d-flex justify-content-between">
            <span>
              <a class="text-decoration-none" href="{% url 'billing:accounts_aging_bucket_detail' key %}?asof={{ today|date:'Y-m-d' }}">{{ b.label }}</a>
            </span>
            <span class="fw-bold">${{ b.total|floatformat:2|intcomma }}</span>
          </li>
          {% endfor %}
        </ul>
      </div>
    </div>
  </div>
</div>

<div class="card">
  <div class="table-responsive">
    <table class="table table-hover mb-0">
      <thead class="table-light">
        <tr>
          <th>Client</th>
          <th class="text-end">Invoices</th>
          <th class="text-end">Outstanding</th>
        </tr>
      </thead>
      <tbody>
        {% for r in client_rows %}
        <tr>
          <td>
            <a class="text-decoration-none" href="{% url 'billing:accounts_aging_client_detail' r.client__id %}">
              {{ r.client__company_name|default:r.client__first_name }} {{ r.client__last_name }}
            </a>
          </td>
          <td class="text-end">{{ r.invoice_count }}</td>
          <td class="text-end fw-bold">${{ r.outstanding_total|floatformat:2|intcomma }}</td>
        </tr>
        {% empty %}
        <tr><td colspan="3" class="text-center text-muted py-4">No outstanding invoices.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endblock %}
