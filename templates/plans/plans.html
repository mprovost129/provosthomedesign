{% extends 'base.html' %}
{% load static humanize plans_extras %}

{% block title %}Plans • Provost Home Design{% endblock %}

{% block content %}
<div class="container-lg py-4">

  {# --- Card image sizing (consistent, no stretch) --- #}
  <style>
    /* Consistent, responsive preview frame */
    .plan-thumb {
      width: 100%;
      aspect-ratio: 16 / 10;   /* choose 16/9 or 16/10 to taste */
      object-fit: cover;       /* crop to fill without distortion */
      height: auto;            /* let aspect-ratio compute the height */
      display: block;
    }
    /* Fallback “no image” box matches the same frame */
    .plan-thumb-placeholder {
      width: 100%;
      aspect-ratio: 16 / 10;
      display: flex;
      align-items: center;
      justify-content: center;
    }
  </style>

  <!-- Page header -->
  <header class="mb-3">
    <h1 class="h3 mb-1">{{ page.title|default:"Plans" }}</h1>
    <p class="text-muted mb-0">{{ page.description|default:"Explore our house plans." }}</p>
  </header>

  <!-- Filters -->
  <form class="row g-2 align-items-end mb-3" method="get" novalidate>
    <div class="col-12 col-md-4">
      <label for="q" class="form-label">Search</label>
      <input id="q" type="text" class="form-control" name="q" placeholder="Plan # or keywords"
             value="{{ filters.q|default_if_none:'' }}">
    </div>

    <div class="col-6 col-md-2">
      <label for="min_sqft" class="form-label">Min sq ft</label>
      <select id="min_sqft" name="min_sqft" class="form-select">
        <option value="">Any</option>
        {% for n in sqft_choices %}
          {% with n_str=n|stringformat:"s" sel=filters.min_sqft|stringformat:"s" %}
            <option value="{{ n_str }}" {% if sel == n_str %}selected{% endif %}>{{ n|intcomma }}</option>
          {% endwith %}
        {% endfor %}
      </select>
    </div>

    <div class="col-6 col-md-2">
      <label for="max_sqft" class="form-label">Max sq ft</label>
      <select id="max_sqft" name="max_sqft" class="form-select">
        <option value="">Any</option>
        {% for n in sqft_choices %}
          {% with n_str=n|stringformat:"s" sel=filters.max_sqft|stringformat:"s" %}
            <option value="{{ n_str }}" {% if sel == n_str %}selected{% endif %}>{{ n|intcomma }}</option>
          {% endwith %}
        {% endfor %}
      </select>
    </div>

    <div class="col-6 col-md-2">
      <label for="beds" class="form-label">Bedrooms</label>
      <select id="beds" name="beds" class="form-select">
        <option value="">Any</option>
        {% for b in bed_choices %}
          {% with b_str=b|stringformat:"s" sel=filters.beds|stringformat:"s" %}
            <option value="{{ b_str }}" {% if sel == b_str %}selected{% endif %}>{{ b }}</option>
          {% endwith %}
        {% endfor %}
      </select>
    </div>

    <div class="col-6 col-md-2">
      <label for="baths" class="form-label">Bathrooms</label>
      <select id="baths" name="baths" class="form-select">
        <option value="">Any</option>
        {% for b in bath_choices %}
          {% with b_str=b|stringformat:"s" sel=filters.baths|stringformat:"s" %}
            <option value="{{ b_str }}" {% if sel == b_str %}selected{% endif %}>{{ b }}</option>
          {% endwith %}
        {% endfor %}
      </select>
    </div>

    <div class="col-6 col-md-2">
      <label for="sort" class="form-label">Sort</label>
      <select id="sort" name="sort" class="form-select">
        {% with s=filters.sort|default:"newest" %}
          <option value="newest" {% if s == "newest" %}selected{% endif %}>Newest</option>
          <option value="sqft_asc" {% if s == "sqft_asc" %}selected{% endif %}>Sq ft ↑</option>
          <option value="sqft_desc" {% if s == "sqft_desc" %}selected{% endif %}>Sq ft ↓</option>
          <option value="price_asc" {% if s == "price_asc" %}selected{% endif %}>Price ↑</option>
          <option value="price_desc" {% if s == "price_desc" %}selected{% endif %}>Price ↓</option>
        {% endwith %}
      </select>
    </div>

    <div class="col-6 col-md-2">
      <button type="submit" class="btn btn-primary w-100">Apply</button>
    </div>
    <div class="col-6 col-md-2">
      <a class="btn btn-outline-primary w-100" href="{% url 'plans:plan_list' %}">Clear</a>
    </div>
  </form>

  <!-- Results meta -->
  <div class="d-flex justify-content-between align-items-center mb-2">
    <div class="text-muted">
      {% if plans and plans.paginator.count %}
        Showing {{ plans.start_index }}–{{ plans.end_index }} of {{ plan_count|default:plans.paginator.count|intcomma }}
      {% else %}
        0 results
      {% endif %}
    </div>
  </div>

  {% if plans and plans.paginator.count %}
    <!-- Grid -->
    <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-3">
      {% for p in plans %}
        <div class="col">
          <div class="card h-100 shadow-sm">

            {% if p.main_image %}
              <img
                src="{{ p.main_image.url }}"
                class="card-img-top plan-thumb"
                alt="Plan {{ p.plan_number }}"
                loading="lazy" decoding="async">
            {% else %}
              <div class="bg-light text-muted small plan-thumb-placeholder">
                No image
              </div>
            {% endif %}

            <div class="card-body">
              <h2 class="h6 card-title mb-1">
                <a href="{{ p.get_absolute_url }}" class="stretched-link text-decoration-none">
                  Plan {{ p.plan_number }}
                </a>
              </h2>
              <p class="text-muted small mb-0">
                {{ p.square_footage|intcomma }} sq ft • {{ p.bedrooms }} bed • {{ p.bathrooms|bath_label }} bath
              </p>
            </div>
          </div>
        </div>
      {% endfor %}
    </div>

    <!-- Pagination -->
    {% if plans.paginator.num_pages > 1 %}
      <nav class="mt-4" aria-label="Plans pagination">
        <ul class="pagination justify-content-center">

          {# Prev #}
          <li class="page-item {% if not plans.has_previous %}disabled{% endif %}">
            {% if plans.has_previous %}
              <a class="page-link"
                 href="?page={{ plans.previous_page_number }}{% if filters.q %}&q={{ filters.q|urlencode }}{% endif %}{% if filters.min_sqft %}&min_sqft={{ filters.min_sqft }}{% endif %}{% if filters.max_sqft %}&max_sqft={{ filters.max_sqft }}{% endif %}{% if filters.beds %}&beds={{ filters.beds }}{% endif %}{% if filters.baths %}&baths={{ filters.baths }}{% endif %}{% if filters.sort %}&sort={{ filters.sort }}{% endif %}{% if filters.style %}&style={{ filters.style }}{% endif %}">
                Previous
              </a>
            {% else %}
              <span class="page-link" aria-disabled="true">Previous</span>
            {% endif %}
          </li>

          {# Numbers (window of ±2) #}
          {% for num in plans.paginator.page_range %}
            {% if num == plans.number %}
              <li class="page-item active" aria-current="page">
                <span class="page-link">{{ num }}</span>
              </li>
            {% elif num >= plans.number|add:'-2' and num <= plans.number|add:'2' %}
              <li class="page-item">
                <a class="page-link"
                   href="?page={{ num }}{% if filters.q %}&q={{ filters.q|urlencode }}{% endif %}{% if filters.min_sqft %}&min_sqft={{ filters.min_sqft }}{% endif %}{% if filters.max_sqft %}&max_sqft={{ filters.max_sqft }}{% endif %}{% if filters.beds %}&beds={{ filters.beds }}{% endif %}{% if filters.baths %}&baths={{ filters.baths }}{% endif %}{% if filters.sort %}&sort={{ filters.sort }}{% endif %}{% if filters.style %}&style={{ filters.style }}{% endif %}">
                  {{ num }}
                </a>
              </li>
            {% endif %}
          {% endfor %}

          {# Next #}
          <li class="page-item {% if not plans.has_next %}disabled{% endif %}">
            {% if plans.has_next %}
              <a class="page-link"
                 href="?page={{ plans.next_page_number }}{% if filters.q %}&q={{ filters.q|urlencode }}{% endif %}{% if filters.min_sqft %}&min_sqft={{ filters.min_sqft }}{% endif %}{% if filters.max_sqft %}&max_sqft={{ filters.max_sqft }}{% endif %}{% if filters.beds %}&beds={{ filters.beds }}{% endif %}{% if filters.baths %}&baths={{ filters.baths }}{% endif %}{% if filters.sort %}&sort={{ filters.sort }}{% endif %}{% if filters.style %}&style={{ filters.style }}{% endif %}">
                Next
              </a>
            {% else %}
              <span class="page-link" aria-disabled="true">Next</span>
            {% endif %}
          </li>

        </ul>
      </nav>
    {% endif %}
  {% else %}
    <div class="alert alert-info">No plans match your filters.</div>
  {% endif %}

</div>
{% endblock %}
