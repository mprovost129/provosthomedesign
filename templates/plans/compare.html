{% extends "base.html" %}
{% load static %}

{% block title %}Compare Plans | Provost Home Design{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row mb-4">
        <div class="col-md-12 d-flex justify-content-between align-items-center">
            <div>
                <h1 class="display-5">
                    <i class="bi bi-bar-chart-fill"></i> Compare Plans
                </h1>
                <p class="text-muted">Comparing {{ plans|length }} plan{% if plans|length != 1 %}s{% endif %}</p>
            </div>
            {% if plans %}
                <div>
                    <a href="{% url 'plans:clear_comparison' %}" class="btn btn-outline-danger">
                        <i class="bi bi-trash"></i> Clear All
                    </a>
                    <a href="{% url 'plans:plan_list' %}" class="btn btn-outline-primary">
                        <i class="bi bi-plus-circle"></i> Add More
                    </a>
                </div>
            {% endif %}
        </div>
    </div>

    {% if plans %}
        <!-- Comparison Table (Desktop) -->
        <div class="table-responsive d-none d-lg-block">
            <table class="table table-bordered table-hover">
                <thead class="table-light">
                    <tr>
                        <th style="width: 200px;">Feature</th>
                        {% for plan in plans %}
                            <th class="text-center">
                                <a href="{% url 'plans:plan_detail' plan.house_style.slug plan.slug %}" 
                                   class="text-decoration-none">
                                    {{ plan.name }}
                                </a>
                                <br>
                                <button class="btn btn-sm btn-outline-danger mt-2 remove-from-comparison" 
                                        data-plan-id="{{ plan.id }}">
                                    Remove
                                </button>
                            </th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    <!-- Images -->
                    <tr>
                        <th>Image</th>
                        {% for plan in plans %}
                            <td class="text-center">
                                {% if plan.main_image %}
                                    <img src="{{ plan.main_image.url }}" 
                                         alt="{{ plan.name }}"
                                         class="img-fluid rounded"
                                         style="max-height: 200px; object-fit: cover;">
                                {% else %}
                                    <div class="bg-light p-4 text-muted">No image</div>
                                {% endif %}
                            </td>
                        {% endfor %}
                    </tr>
                    
                    <!-- Style -->
                    <tr>
                        <th>Style</th>
                        {% for plan in plans %}
                            <td class="text-center">{{ plan.house_style.name }}</td>
                        {% endfor %}
                    </tr>
                    
                    <!-- Square Feet -->
                    <tr>
                        <th>Square Feet</th>
                        {% for plan in plans %}
                            <td class="text-center"><strong>{{ plan.square_feet }}</strong> sq ft</td>
                        {% endfor %}
                    </tr>
                    
                    <!-- Bedrooms -->
                    <tr>
                        <th>Bedrooms</th>
                        {% for plan in plans %}
                            <td class="text-center">{{ plan.bedrooms }}</td>
                        {% endfor %}
                    </tr>
                    
                    <!-- Bathrooms -->
                    <tr>
                        <th>Bathrooms</th>
                        {% for plan in plans %}
                            <td class="text-center">{{ plan.bathrooms }}</td>
                        {% endfor %}
                    </tr>
                    
                    <!-- Floors -->
                    <tr>
                        <th>Floors</th>
                        {% for plan in plans %}
                            <td class="text-center">{{ plan.floors|default:"—" }}</td>
                        {% endfor %}
                    </tr>
                    
                    <!-- Dimensions -->
                    <tr>
                        <th>Width</th>
                        {% for plan in plans %}
                            <td class="text-center">{{ plan.width_feet|default:"—" }}{% if plan.width_feet %} ft{% endif %}</td>
                        {% endfor %}
                    </tr>
                    <tr>
                        <th>Depth</th>
                        {% for plan in plans %}
                            <td class="text-center">{{ plan.depth_feet|default:"—" }}{% if plan.depth_feet %} ft{% endif %}</td>
                        {% endfor %}
                    </tr>
                    <tr>
                        <th>Height</th>
                        {% for plan in plans %}
                            <td class="text-center">{{ plan.height_feet|default:"—" }}{% if plan.height_feet %} ft{% endif %}</td>
                        {% endfor %}
                    </tr>
                    
                    <!-- Garage -->
                    <tr>
                        <th>Garage</th>
                        {% for plan in plans %}
                            <td class="text-center">{{ plan.garage_bays|default:"—" }}{% if plan.garage_bays %} car{% if plan.garage_bays > 1 %}s{% endif %}{% endif %}</td>
                        {% endfor %}
                    </tr>
                    
                    <!-- Foundation -->
                    <tr>
                        <th>Foundation</th>
                        {% for plan in plans %}
                            <td class="text-center">{{ plan.foundation_type|default:"—" }}</td>
                        {% endfor %}
                    </tr>
                    
                    <!-- Price -->
                    <tr>
                        <th>Price</th>
                        {% for plan in plans %}
                            <td class="text-center">
                                {% if plan.price %}
                                    <strong class="text-primary">${{ plan.price|floatformat:0 }}</strong>
                                {% else %}
                                    <span class="text-muted">Call for pricing</span>
                                {% endif %}
                            </td>
                        {% endfor %}
                    </tr>
                    
                    <!-- Actions -->
                    <tr class="table-light">
                        <th>Actions</th>
                        {% for plan in plans %}
                            <td class="text-center">
                                <a href="{% url 'plans:plan_detail' plan.house_style.slug plan.slug %}" 
                                   class="btn btn-primary btn-sm mb-1">
                                    View Details
                                </a>
                                <br>
                                <a href="{% url 'pages:get_started' %}?plan={{ plan.id }}" 
                                   class="btn btn-success btn-sm">
                                    Get Started
                                </a>
                            </td>
                        {% endfor %}
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Comparison Cards (Mobile) -->
        <div class="d-lg-none">
            {% for plan in plans %}
                <div class="card mb-4 comparison-card" data-plan-id="{{ plan.id }}">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">{{ plan.name }}</h5>
                        <button class="btn btn-sm btn-outline-danger remove-from-comparison" 
                                data-plan-id="{{ plan.id }}">
                            <i class="bi bi-x-circle"></i>
                        </button>
                    </div>
                    <div class="card-body">
                        {% if plan.main_image %}
                            <img src="{{ plan.main_image.url }}" 
                                 alt="{{ plan.name }}"
                                 class="img-fluid rounded mb-3">
                        {% endif %}
                        
                        <table class="table table-sm">
                            <tr><th>Style:</th><td>{{ plan.house_style.name }}</td></tr>
                            <tr><th>Square Feet:</th><td>{{ plan.square_feet }} sq ft</td></tr>
                            <tr><th>Bedrooms:</th><td>{{ plan.bedrooms }}</td></tr>
                            <tr><th>Bathrooms:</th><td>{{ plan.bathrooms }}</td></tr>
                            <tr><th>Floors:</th><td>{{ plan.floors|default:"—" }}</td></tr>
                            <tr><th>Dimensions:</th><td>{{ plan.width_feet|default:"—" }}' × {{ plan.depth_feet|default:"—" }}' × {{ plan.height_feet|default:"—" }}'</td></tr>
                            <tr><th>Garage:</th><td>{{ plan.garage_bays|default:"—" }}{% if plan.garage_bays %} car{% if plan.garage_bays > 1 %}s{% endif %}{% endif %}</td></tr>
                            <tr><th>Foundation:</th><td>{{ plan.foundation_type|default:"—" }}</td></tr>
                            <tr><th>Price:</th><td>{% if plan.price %}${{ plan.price|floatformat:0 }}{% else %}Call for pricing{% endif %}</td></tr>
                        </table>
                        
                        <div class="d-grid gap-2">
                            <a href="{% url 'plans:plan_detail' plan.house_style.slug plan.slug %}" 
                               class="btn btn-primary">
                                View Details
                            </a>
                            <a href="{% url 'pages:get_started' %}?plan={{ plan.id }}" 
                               class="btn btn-success">
                                Get Started
                            </a>
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>
        
        {% if plans|length < 4 %}
            <div class="alert alert-info">
                <i class="bi bi-info-circle"></i> 
                You can compare up to 4 plans. <a href="{% url 'plans:plan_list' %}" class="alert-link">Add more plans</a> to compare.
            </div>
        {% endif %}
    {% else %}
        <div class="row">
            <div class="col-md-12 text-center py-5">
                <i class="bi bi-bar-chart display-1 text-muted"></i>
                <h3 class="mt-3">No plans to compare</h3>
                <p class="text-muted">Start browsing and add plans to compare them side-by-side!</p>
                <a href="{% url 'plans:plan_list' %}" class="btn btn-primary mt-3">
                    Browse Plans
                </a>
            </div>
        </div>
    {% endif %}
</div>

<script>
// Remove from comparison (AJAX)
document.querySelectorAll('.remove-from-comparison').forEach(btn => {
    btn.addEventListener('click', function(e) {
        e.preventDefault();
        const planId = this.dataset.planId;
        
        fetch(`/plans/compare/toggle/${planId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json',
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Reload page to update comparison
                location.reload();
            }
        })
        .catch(error => console.error('Error:', error));
    });
});
</script>
{% endblock %}
